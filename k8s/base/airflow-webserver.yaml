apiVersion: apps/v1
kind: Deployment
metadata: { name: airflow-webserver }
spec:
  replicas: 1
  selector: { matchLabels: { app: airflow-webserver } }
  template:
    metadata: { labels: { app: airflow-webserver } }
    spec:
      containers:
      - name: web
        image: airflow-local:step7
        command: ["bash","-lc","airflow db init && airflow users create --username admin --password admin --firstname Admin --lastname User --role Admin --email admin@example.com || true && airflow webserver"]
        envFrom:
          - configMapRef: { name: airflow-env }
          - secretRef:    { name: airflow-secrets }
        ports: [ { containerPort: 8080, name: http } ]
        readinessProbe: { httpGet: { path: /health, port: http }, initialDelaySeconds: 40, periodSeconds: 10 }
        livenessProbe:  { httpGet: { path: /health, port: http }, initialDelaySeconds: 90, periodSeconds: 10 }
        resources:
          requests: { cpu: "300m", memory: "512Mi" }
          limits:   { cpu: "1",    memory: "1Gi" }
---
apiVersion: v1
kind: Service
metadata: { name: airflow-webserver }
spec:
  type: NodePort
  selector: { app: airflow-webserver }
  ports:
    - name: http
      port: 8080
      targetPort: http
      nodePort: 30000
