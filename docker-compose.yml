# docker-compose.yml

version: '3.8'

services:
  # --------------------------------------------------------------------------
  # Hadoop NameNode Service
  # --------------------------------------------------------------------------
  namenode:
    image: bde2020/hadoop-namenode:2.0.0-hadoop3.2.1-java8
    hostname: namenode
    container_name: namenode
    ports:
      - "9870:9870"
      - "9000:9000"
    volumes:
      - namenode-data:/hadoop/dfs/name
    environment:
      - CLUSTER_NAME=test-cluster
      - HDFS_USER=hdfs
      - CORE_CONF_fs_defaultFS=hdfs://namenode:9000
    env_file:
      - ./hadoop.env
    networks:
      - big-data-net
    healthcheck:
      test: ["CMD", "hdfs", "dfsadmin", "-report"]
      interval: 10s
      timeout: 5s
      retries: 5
    mem_limit: 1g

  # --------------------------------------------------------------------------
  # Hadoop DataNode Service
  # --------------------------------------------------------------------------
  datanode:
    image: bde2020/hadoop-datanode:2.0.0-hadoop3.2.1-java8
    hostname: datanode
    container_name: datanode
    volumes:
      - datanode-data:/hadoop/dfs/data
    environment:
      - CLUSTER_NAME=test-cluster
      - HDFS_USER=hdfs
      - CORE_CONF_fs_defaultFS=hdfs://namenode:9000
    env_file:
      - ./hadoop.env
    networks:
      - big-data-net
    depends_on:
      namenode:
        condition: service_healthy
    mem_limit: 2g

  # --------------------------------------------------------------------------
  # MariaDB Service (New Hive Metastore)
  # --------------------------------------------------------------------------
  mariadb:
    image: mariadb:10.6
    hostname: mariadb
    container_name: mariadb
    ports:
      - "3306:3306"
    volumes:
      - mariadb-data:/var/lib/mysql
    environment:
      - MARIADB_ROOT_PASSWORD=your_root_password
      - MARIADB_DATABASE=hive_metastore
      - MARIADB_USER=hive
      - MARIADB_PASSWORD=hive_password
    networks:
      - big-data-net
    healthcheck:
      test: ["CMD", "mariadb-admin", "ping", "-h", "localhost", "-u", "root", "-p$$MARIADB_ROOT_PASSWORD"]
      interval: 10s
      timeout: 5s
      retries: 5
    mem_limit: 512m

  # --------------------------------------------------------------------------
  # Hive Service (Metastore and HiveServer2)
  # --------------------------------------------------------------------------
  hive-server:
    image: apache/hive:3.1.3
    container_name: hive-server
    hostname: hive-server
    ports:
      - "10000:10000"
      - "9083:9083"
    volumes:
      - ./hive-site.xml:/opt/hive/conf/hive-site.xml
      - ./hive-start.sh:/usr/local/bin/hive-start.sh
      - ./mysql-connector-j-8.4.0.jar:/opt/hive/lib/mysql-connector-j-8.4.0.jar
    environment:
      - SKIP_SCHEMA_INIT=true            # <- prevent the image from doing its own Derby init
      - HIVE_DB=mysql                   # <- fix the earlier typo
      - HIVE_AUX_JARS_PATH=/opt/hive/lib/mysql-connector-j-8.4.0.jar
      - HADOOP_CONF_fs_defaultFS=hdfs://namenode:9000
    networks:
      - big-data-net
    depends_on:
      namenode:
        condition: service_healthy
      mariadb:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "/opt/hive/bin/beeline -u 'jdbc:hive2://localhost:10000/' -n hive -e 'set hive.execution.engine=mr; show databases;' >/dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 30s
      retries: 10
      start_period: 150s
    entrypoint: ["/usr/local/bin/hive-start.sh"]
    
    

  # --------------------------------------------------------------------------
  # MongoDB Service
  # --------------------------------------------------------------------------
  mongodb:
    image: mongo:6.0
    hostname: mongodb
    container_name: mongodb
    ports:
      - "27017:27017"
    volumes:
      - mongodb-data:/data/db
    environment:
      - MONGO_INITDB_ROOT_USERNAME=mongouser
      - MONGO_INITDB_ROOT_PASSWORD=mongopassword
    networks:
      - big-data-net
    healthcheck:
      test: [ "CMD", "mongosh", "--eval", "db.adminCommand('ping')", "--quiet" ]
      interval: 10s
      timeout: 5s
      retries: 5
    mem_limit: 512m

  # --------------------------------------------------------------------------
  # JupyterLab Service
  # --------------------------------------------------------------------------
  jupyterlab:
    image: jupyter/scipy-notebook:latest
    hostname: jupyterlab
    container_name: jupyterlab
    ports:
      - "8888:8888"
    volumes:
      - ./notebooks:/home/jovyan/work
    environment:
      - JUPYTER_ENABLE_LAB=yes
      - GRANT_SUDO=yes
      - NB_UID=1000
      - NB_GID=100
      - HADOOP_NAMENODE_HOST=namenode
      - HIVE_SERVER_HOST=hive-server
      - HIVE_SERVER_PORT=10000
      - MARIADB_HOST=mariadb
      - MARIADB_PORT=3306
      - MARIADB_USER=hive
      - MARIADB_PASSWORD=hive_password
      - MONGODB_HOST=mongodb
      - MONGODB_PORT=27017
      - MONGODB_USER=mongouser
      - MONGODB_PASSWORD=mongopassword
    networks:
      - big-data-net
    depends_on:
      namenode:
        condition: service_healthy
      hive-server:
        condition: service_healthy
      mariadb:
        condition: service_healthy
      mongodb:
        condition: service_healthy
    mem_limit: 1.5g
    command: start-notebook.sh --NotebookApp.token='' --NotebookApp.allow_origin='*'

# --------------------------------------------------------------------------
# Docker Volumes for Persistent Data
# --------------------------------------------------------------------------
volumes:
  namenode-data:
  datanode-data:
  mariadb-data:
  mongodb-data:

# --------------------------------------------------------------------------
# Docker Network for Inter-Service Communication
# --------------------------------------------------------------------------
networks:
  big-data-net:
    driver: bridge
